/*! jQuery Fancytree Plugin - v2.0.0pre - 2013-05-07
* https://github.com/mar10/fancytree
* Copyright (c) 2013 Martin Wendt; Licensed MIT */(function(e){"use strict";function t(t){t=t||"",e.error("Not implemented: "+t)}function n(t,n){n=": "+n||"",t||e.error("Assertion failed"+n)}function i(e,t,n){var i=t[e],r=n[e];return function(){try{return t._super=function(){return i.apply(t,arguments)},r.apply(t,arguments)}finally{t._super=null}}}function r(t,n,r,o){e.ui.fancytree.debug("_subclassObject",n,r,o);for(var a in r)"function"==typeof r[a]?"function"==typeof t[a]?t[a]=i(a,t,r):"_"===a.charAt(0)?t[o][a]=e.proxy(r[a],t):e.error("Could not override tree."+a+". Use prefix '_' to create tree."+o+"._"+a):"options"!==a&&(t[o][a]=n[a])}function o(t,n){return void 0===t?e.Deferred(function(){this.resolve()}).promise():e.Deferred(function(){this.resolveWith(t,n)}).promise()}function a(t,n){return void 0===t?e.Deferred(function(){this.reject()}).promise():e.Deferred(function(){this.rejectWith(t,n)}).promise()}function s(e,t){return function(){e.resolveWith(t)}}function d(e){return e=e.toLowerCase(),function(t){return t.title.toLowerCase().indexOf(e)>=0}}function l(t,i){var r,o,a,s;for(this.parent=t,this.tree=t.tree,this.ul=null,this.li=null,this.isStatusNode=!1,this.data={},r=0,o=v.length;o>r;r++)a=v[r],this[a]=i[a];i.data&&e.extend(this.data,i.data);for(a in i)g[a]||e.isFunction(i[a])||y[a]||(this.data[a]=i[a]);null==this.key&&(this.key="_"+m._nextNodeKey++),i.active&&(n(null===this.tree.activeNode,"only one active node allowed"),this.tree.activeNode=this),this.children=null,s=i.children,s&&s.length&&this._setChildren(s)}function c(t){this.widget=t,this.$div=t.element,this.options=t.options,this._id=e.ui.fancytree._nextId++,this._ns=".fancytree-"+this._id,this.activeNode=null,this.focusNode=null,this.lastSelectedNode=null,this.statusClassPropName="span",this.ariaPropName="li",this.nodeContainerAttrName="li",this.$div.find(">ul.fancytree-container").remove();var n,i={tree:this};this.rootNode=new l(i,{title:"root",key:"root_"+this._id,children:null}),this.rootNode.parent=null,n=e("<ul>",{"class":"ui-fancytree fancytree-container"}).appendTo(this.$div),this.$container=n,this.rootNode.ul=n[0],this.options.tabbable&&this.$container.attr("tabindex","0"),this.options.aria&&this.$container.attr("role","tree").attr("aria-multiselectable",!0)}function u(e,t){var n=window.console?window.console[e]:null;if(n)if(n.apply)n.apply(window.console,t);else{for(var i="",r=0;t.length>r;r++)i+=t[r];n(i)}}if(e.ui.fancytree&&e.ui.fancytree.version)return e.ui.fancytree.warn("Fancytree: ignored duplicate include"),void 0;var h,f="active expanded focus folder lazy selected".split(" "),p={};for(h=0;f.length>h;h++)p[f[h]]=!0;var v="expanded extraClasses folder key lazy selected title tooltip".split(" "),g={};for(h=0;v.length>h;h++)g[v[h]]=!0;var y={active:!0,children:!0,data:!0,focus:!0};l.prototype={_findDirectChild:function(e){var t=this.children;if(t)if("string"==typeof e){for(var n=0,i=t.length;i>n;n++)if(t[n].key===e)return t[n]}else{if("number"==typeof e)return this.children[e];if(e.parent===this)return e}return null},_setChildren:function(e){n(e&&(!this.children||0===this.children.length),"only init supported"),this.children=[];for(var t=0,i=e.length;i>t;t++)this.children.push(new l(this,e[t]))},addChildren:function(t,i){var r=null;if(e.isPlainObject(t)&&(t=[t]),this.children||(this.children=[]),void 0===i)for(var o=0,a=t.length;a>o;o++)0===o?(r=new l(this,t[o]),this.children.push(r)):this.children.push(new l(this,t[o]));else n(!i,"not implemented"),i=this._findDirectChild(i);return(!this.parent||this.parent.ul)&&this.render(),r},applyPatch:function(t){if(null===t)return this.remove(),o(this);var n,i={children:!0,expanded:!0,parent:!0};for(n in t){var r=t[n];i[n]||e.isFunction(r)||(g[n]?this[n]=r:this.data[n]=r)}t.hasOwnProperty("children")&&(this.removeChildren(),t.children&&this._setChildren(t.children)),this.isVisible()&&(this.renderTitle(),this.renderStatus());var a;return a=t.hasOwnProperty("expanded")?this.setExpanded(t.expanded):o(this)},collapseSiblings:function(){return this.tree._callHook("nodeCollapseSiblings",this)},countChildren:function(e){var t,n,i,r=this.children;if(!r)return 0;if(i=r.length,e!==!1)for(t=0,n=i;n>t;t++)i+=r[t].countChildren();return i},debug:function(){Array.prototype.unshift.call(arguments,""+this),m.debug.apply(this,arguments)},discard:function(){return this.lazy&&e.isArray(this.children)?(this.removeChildren(),this.setExpanded(!1)):void 0},findAll:function(t){t=e.isFunction(t)?t:d(t);var n=[];return this.visit(function(e){t(e)&&n.push(e)}),n},findFirst:function(t){t=e.isFunction(t)?t:d(t);var n=null;return this.visit(function(e){return t(e)?(n=e,!1):void 0}),n},fromDict:function(t){for(var n in t)g[n]?this[n]=t[n]:"data"===n?e.extend(this.data,t.data):e.isFunction(t[n])||y[n]||(this.data[n]=t[n]);t.children?(this.removeChildren(),this.addChildren(t.children)):this.renderTitle()},getChildren:function(){return void 0===this.hasChildren()?void 0:this.children},getFirstChild:function(){return this.children?this.children[0]:null},getIndex:function(){return e.inArray(this,this.parent.children)},getIndexHier:function(t){t=t||".";var n=[];return e.each(this.getParentList(!1,!0),function(e,t){n.push(t.getIndex()+1)}),n.join(t)},getKeyPath:function(e){var t=[],n=this.tree.options.keyPathSeparator;return this.visitParents(function(e){e.parent&&t.unshift(e.key)},!e),n+t.join(n)},getLastChild:function(){return this.children?this.children[this.children.length-1]:null},getLevel:function(){for(var e=0,t=this.parent;t;)e++,t=t.parent;return e},getNextSibling:function(){if(this.parent)for(var e=this.parent.children,t=0,n=e.length-1;n>t;t++)if(e[t]===this)return e[t+1];return null},getParent:function(){return this.parent},getParentList:function(e,t){for(var n=[],i=t?this:this.parent;i;)(e||i.parent)&&n.unshift(i),i=i.parent;return n},getPrevSibling:function(){if(this.parent)for(var e=this.parent.children,t=1,n=e.length;n>t;t++)if(e[t]===this)return e[t-1];return null},hasChildren:function(){return this.lazy?null===this.children||void 0===this.children?void 0:0===this.children.length?!1:1===this.children.length&&this.children[0].isStatusNode?void 0:!0:!!this.children},hasFocus:function(){return this.tree.hasFocus()&&this.tree.focusNode===this},isActive:function(){return this.tree.activeNode===this},isChildOf:function(e){return this.parent&&this.parent===e},isDescendantOf:function(e){if(!e||e.tree!==this.tree)return!1;for(var t=this.parent;t;){if(t===e)return!0;t=t.parent}return!1},isExpanded:function(){return!!this.expanded},isFirstSibling:function(){var e=this.parent;return!e||e.children[0]===this},isFolder:function(){return!!this.folder},isLastSibling:function(){var e=this.parent;return!e||e.children[e.children.length-1]===this},isLazy:function(){return!!this.lazy},isLoading:function(){t()},isRoot:function(){return this.tree.rootNode===this},isSelected:function(){return!!this.selected},isVisible:function(){for(var e=this.getParentList(!1,!1),t=0,n=e.length;n>t;t++)if(!e[t].expanded)return!1;return!0},makeVisible:function(){for(var e=this.getParentList(!1,!1),t=0,n=e.length;n>t;t++)e[t].setExpanded(!0)},move:function(t,n){(void 0===n||"over"===n)&&(n="child");var i,r=this.parent,o="child"===n?t:t.parent;if(this!==t){if(!this.parent)throw"Cannot move system root";if(o.isDescendantOf(this))throw"Cannot move a node to it's own descendant";if(1===this.parent.children.length)this.parent.children=this.parent.lazy?[]:null,this.parent.expanded=!1;else{if(i=e.inArray(this,this.parent.children),0>i)throw"Internal error";this.parent.children.splice(i,1)}if(this.parent=o,o.hasChildren())switch(n){case"child":o.children.push(this);break;case"before":if(i=e.inArray(t,o.children),0>i)throw"Internal error";o.children.splice(i,0,this);break;case"after":if(i=e.inArray(t,o.children),0>i)throw"Internal error";o.children.splice(i+1,0,this);break;default:throw"Invalid mode "+n}else o.children=[this];if(this.tree!==t.tree)throw"Cross-tree move is not yet implemented.";r.isDescendantOf(o)||r.render(),o.isDescendantOf(r)||o===r||o.render()}},lazyLoad:function(t){t?this.discard():n(!e.isArray(this.children));var i=this.tree._triggerNodeEvent("lazyload",this);return n("boolean"!=typeof i,"lazyload event must return source in data.result"),this.tree._callHook("nodeLoadChildren",this,i)},render:function(e,t){return this.tree._callHook("nodeRender",this,e,t)},renderTitle:function(){return this.tree._callHook("nodeRenderTitle",this)},renderStatus:function(){return this.tree._callHook("nodeRenderStatus",this)},remove:function(){return this.parent.removeChild(this)},removeChild:function(e){return this.tree._callHook("nodeRemoveChild",this,e)},removeChildren:function(){return this.tree._callHook("nodeRemoveChildren",this)},scheduleAction:function(e,t){this.tree.timer&&clearTimeout(this.tree.timer),this.tree.timer=null;var n=this;switch(e){case"cancel":break;case"expand":this.tree.timer=setTimeout(function(){n.tree.debug("setTimeout: trigger expand"),n.setExpanded(!0)},t);break;case"activate":this.tree.timer=setTimeout(function(){n.tree.debug("setTimeout: trigger activate"),n.setActive(!0)},t);break;default:throw"Invalid mode "+e}},scrollIntoView:function(t,n){t=t===!0?{duration:200,queue:!1}:t;var i=new e.Deferred,r=e(this.span).position().top,o=e(this.span).height(),a=this.tree.$container,s=a.height(),d=a[0].scrollTop,l=null;if(0>r)l=d+r;else if(r+o>s&&(l=d+r-s+o,n)){var c=n?e(n.span).position().top:0;r-c>s&&(l=d+r)}return null!==l?t?a.animate({scrollTop:l},t):(a[0].scrollTop=l,i.resolveWith(this)):i.resolveWith(this),i.promise()},setActive:function(e){return this.tree._callHook("nodeSetActive",this,e)},setExpanded:function(e){return this.tree._callHook("nodeSetExpanded",this,e)},setFocus:function(e){return this.tree._callHook("nodeSetFocus",this,e)},setSelected:function(e){return this.tree._callHook("nodeSetSelected",this,e)},setTitle:function(e){this.title=e,this.renderTitle()},sortChildren:function(e,t){var n=this.children;if(n){if(e=e||function(e,t){var n=e.title.toLowerCase(),i=t.title.toLowerCase();return n===i?0:n>i?1:-1},n.sort(e),t)for(var i=0,r=n.length;r>i;i++)n[i].children&&n[i].sortChildren(e,"$norender$");"$norender$"!==t&&this.render()}},toDict:function(t,n){var i={},r=this;if(e.each(v,function(e,t){(r[t]||r[t]===!1)&&(i[t]=r[t])}),e.isEmptyObject(this.data)||(i.data=e.extend({},this.data),e.isEmptyObject(i.data)&&delete i.data),n&&n(i),t&&this.hasChildren()){i.children=[];for(var o=0,a=this.children.length;a>o;o++)i.children.push(this.children[o].toDict(!0,n))}return i},toggleExpanded:function(){return this.tree._callHook("nodeToggleExpanded",this)},toggleSelected:function(){return this.tree._callHook("nodeToggleSelected",this)},toString:function(){return"<FancytreeNode(#"+this.key+", '"+this.title+"')>"},visit:function(e,t){var n=!0,i=this.children;if(t===!0&&(n=e(this),n===!1||"skip"===n))return n;if(i)for(var r=0,o=i.length;o>r&&(n=i[r].visit(e,!0),n!==!1);r++);return n},visitParents:function(e,t){if(t&&e(this)===!1)return!1;for(var n=this.parent;n;){if(e(n)===!1)return!1;n=n.parent}return!0}},c.prototype={_makeHookContext:function(t,n){if(void 0!==t.node)return n&&t.orgEvent!==n&&e.error("invalid args"),t;if(t.tree){var i=t.tree;return{node:t,tree:i,widget:i.widget,options:i.widget.options,orgEvent:n}}return t.widget?{node:null,tree:t,widget:t.widget,options:t.widget.options,orgEvent:n}:(e.error("invalid args"),void 0)},_callHook:function(t,n){var i=this._makeHookContext(n),r=this[t],o=Array.prototype.slice.call(arguments,2);return e.isFunction(r)||e.error("_callHook('"+t+"') is not a function"),o.unshift(i),r.apply(this,o)},activateKey:function(e){var t=this.getNodeByKey(e);return t?t.setActive():this.activeNode&&this.activeNode.setActive(!1),t},applyPatch:function(t){for(var i,r,o,a,d=t.length,l=[],c=0;d>c;c++)if(i=t[c],n(2===i.length,"patchList must be an array of length-2-arrays"),r=i[0],o=i[1],a=null===r?this.rootNode:this.getNodeByKey(r)){var u=new e.Deferred;l.push(u),a.applyPatch(o).always(s(u,a))}else this.warn("could not find node with key '"+r+"'");return e.when.apply(e,l).promise()},count:function(){return this.rootNode.countChildren()},debug:function(){Array.prototype.unshift.call(arguments,""+this),m.debug.apply(this,arguments)},generateFormElements:function(t,n){var i=t!==!1?"ft_"+this._id:t,r=n!==!1?"ft_"+this._id+"_active":n,o="fancytree_result_"+this._id,a=this.$container.find("div#"+o);if(a.length?a.empty():a=e("<div>",{id:o}).hide().appendTo(this.$container),i){var s=this.getSelectedNodes(3===this.options.selectMode);e.each(s,function(t,n){a.append(e("<input>",{type:"checkbox",name:i,value:n.key,checked:!0}))})}r&&this.activeNode&&a.append(e("<input>",{type:"radio",name:r,value:this.activeNode.key,checked:!0}))},getActiveNode:function(){return this.activeNode},getFirstChild:function(){return this.rootNode.getFirstChild()},getFocusNode:function(){return this.focusNode},getNodeByKey:function(e,t){if(!t){var n=document.getElementById(this.options.idPrefix+e);if(n)return n.ftnode?n.ftnode:null}var i=null;return t=t||this.rootNode,t.visit(function(t){return t.key===e?(i=t,!1):void 0},!0),i},getSelectedNodes:function(e){var t=[];return this.rootNode.visit(function(n){return n.selected&&(t.push(n),e===!0)?"skip":void 0}),t},hasFocus:function(){return m.focusTree===this},info:function(){Array.prototype.unshift.call(arguments,""+this),m.info.apply(this,arguments)},loadKeyPath:function(t,n,i){function r(e,t,i){n.call(h,t,"loading"),t.lazyLoad().done(function(){h.loadKeyPath.call(h,f[e],n,t).always(s(i,h))}).fail(function(){h.warn("loadKeyPath: error loading: "+e+" (parent: "+c+")"),n.call(h,t,"error"),i.reject()})}var o,a,d,l,c=i||this.rootNode,u=this.options.keyPathSeparator,h=this;e.isArray(t)||(t=[t]);for(var f={},p=0;t.length>p;p++)for(o=t[p],o.charAt(0)===u&&(o=o.substr(1)),l=o.split(u);l.length;){if(a=l.shift(),d=c._findDirectChild(a),!d){this.warn("loadKeyPath: key not found: "+a+" (parent: "+c+")"),n.call(this,a,"error");break}if(0===l.length){n.call(this,d,"ok");break}if(d.lazy&&void 0===d.hasChildren()){n.call(this,d,"loaded"),f[a]?f[a].push(l.join(u)):f[a]=[l.join(u)];break}n.call(this,d,"loaded"),c=d}var v=[];for(a in f){d=c._findDirectChild(a);var g=new e.Deferred;v.push(g),r(a,d,g)}return e.when.apply(e,v).promise()},nodeClick:function(e){var t=e.orgEvent,n=e.targetType,i=e.node;if("expander"===n)this._callHook("nodeToggleExpanded",e);else if("checkbox"===n)this._callHook("nodeToggleSelected",e),this._callHook("nodeSetFocus",e,!0);else{var r=!1,o=!0;if(i.folder)switch(e.options.clickFolderMode){case 2:r=!0,o=!1;break;case 3:o=!0,r=!0}o&&(this.nodeSetFocus(e),this._callHook("nodeSetActive",e,!0)),r&&this._callHook("nodeToggleExpanded",e)}"a"===t.target.localName&&"fancytree-title"===t.target.className&&t.preventDefault()},nodeCollapseSiblings:function(e){var t=e.node;if(t.parent)for(var n=t.parent.children,i=0,r=n.length;r>i;i++)n[i]!==t&&n[i].expanded&&this._callHook("nodeSetExpanded",n[i],!1)},nodeDblclick:function(e){"title"===e.targetType&&4===e.options.clickFolderMode&&this._callHook("nodeToggleExpanded",e),"title"===e.targetType&&e.orgEvent.preventDefault()},nodeKeydown:function(t){function n(e){return e?(e.makeVisible(),i.ctrlKey||!a.autoActivate?e.setFocus():e.setActive()):void 0}var i=t.orgEvent,r=t.node,o=t.tree,a=t.options,s=!0,d=e.ui.keyCode,l=null;switch(r.debug("ftnode.nodeKeydown("+i.type+"): ftnode:"+this+", charCode:"+i.charCode+", keyCode: "+i.keyCode+", which: "+i.which),i.which){case d.NUMPAD_ADD:case 187:o.nodeSetExpanded(t,!0);break;case d.NUMPAD_SUBTRACT:case 189:o.nodeSetExpanded(t,!1);break;case d.SPACE:a.checkbox?o.nodeToggleSelected(t):o.nodeSetActive(t,!0);break;case d.ENTER:o.nodeSetActive(t,!0);break;case d.BACKSPACE:n(r.parent);break;case d.LEFT:r.expanded?(o.nodeSetExpanded(t,!1),n(r)):r.parent&&r.parent.parent&&n(r.parent);break;case d.RIGHT:r.expanded||!r.children&&!r.lazy?r.children&&n(r.children[0]):(o.nodeSetExpanded(t,!0),n(r));break;case d.UP:for(l=r.getPrevSibling();l&&l.expanded&&l.children;)l=l.children[l.children.length-1];!l&&r.parent&&r.parent.parent&&(l=r.parent),n(l);break;case d.DOWN:if(r.expanded&&r.children)l=r.children[0];else for(var c=r.getParentList(!1,!0),u=c.length-1;u>=0&&!(l=c[u].getNextSibling());u--);n(l);break;default:s=!1}s&&i.preventDefault()},nodeLoadChildren:function(t,i){var r,o,a=t.tree,s=t.node;if(e.isFunction(i)&&(i=i()),i.url||e.isFunction(i.done)){if(a.nodeSetStatus(t,"loading"),i.url){var d=e.extend({},t.options.ajax,i);if(d.debugLazyDelay){var l=d.debugLazyDelay;e.isArray(l)&&(l=l[0]+Math.random()*(l[1]-l[0])),s.debug("nodeLoadChildren waiting debug delay "+Math.round(l)+"ms"),o=e.Deferred();var c=this;return setTimeout(function(){d.debugLazyDelay=!1,c.nodeLoadChildren(t,d).complete(function(){o.resolve.apply(this,arguments)})},l),o}o=e.ajax(d)}else o=i;o.done(function(n){a.nodeSetStatus(t,"ok"),r=n,"string"==typeof r&&e.error("Ajax request returned a string (did you get the JSON dataType wrong?).")}).fail(function(e,n,i){a.nodeSetStatus(t,"error",n,e.status+": "+i),alert("error: "+n+" ("+e.status+": "+(i.message||i)+")")})}else o=e.Deferred(),r=i,o.resolve();return o.done(function(){n(e.isArray(r),"expected array of children"),s._setChildren(r),s.parent&&(s.isVisible()&&a.nodeRender(t),a._triggerNodeEvent("loadchildren",s))}).fail(function(){a.nodeRender(t)}),o},nodeLoadKeyPath:function(){},nodeMakeVisible:function(e){for(var t=e.node.getParentList(!1,!1),n=0,i=t.length;i>n;n++)t[n].setExpanded(!0)},nodeRemoveChild:function(t,i){var r=t.node,o=r.children;if(m.debug("nodeRemoveChild()",""+r,""+i),1===o.length)return n(i===o[0]),this.nodeRemoveChildren(t);this.activeNode&&(i===this.activeNode||this.activeNode.isDescendantOf(i))&&this.activeNode.setActive(!1),this.focusNode&&(i===this.focusNode||this.focusNode.isDescendantOf(i))&&(this.focusNode=null);var a=e.extend({},t,{node:i});this.nodeRemoveMarkup(a),this.nodeRemoveChildren(a);var s=e.inArray(i,o);n(s>=0),i.visit(function(e){e.parent=null},!0),o.splice(s,1)},nodeRemoveChildMarkup:function(t){var n=t.node;m.debug("nodeRemoveChildMarkup()",""+n),n.ul&&(e(n.ul).remove(),n.visit(function(e){e.li=e.ul=null}),n.ul=null)},nodeRemoveChildren:function(e){var t=e.node,n=t.children;m.debug("nodeRemoveChildren()",""+t),n&&(this.activeNode&&this.activeNode.isDescendantOf(t)&&this.activeNode.setActive(!1),this.focusNode&&this.focusNode.isDescendantOf(t)&&(this.focusNode=null),this.nodeRemoveChildMarkup(e),t.visit(function(e){e.parent=null}),t.children=void 0,this.nodeRenderStatus(e))},nodeRemoveMarkup:function(t){var n=t.node;m.debug("nodeRemoveMarkup()",""+n),n.li&&(e(n.li).remove(),n.li=null),this.nodeRemoveChildMarkup(t)},nodeRender:function(t,i,r,o,a){var s,d,l=t.node,c=t.tree,u=t.options,h=u.aria,f=!1,p=l.parent,v=!p,g=l.children;if(n(v||p.ul,"parent UL must exist"),v||(l.li&&(i||l.li.parentNode!==l.parent.ul)&&(l.li.parentNode!==l.parent.ul&&alert("unlink "+l+" (must be child of "+l.parent+")"),this.nodeRemoveMarkup(t)),l.li||(f=!0,l.li=document.createElement("li"),l.li.ftnode=l,l.key&&u.generateIds&&(l.li.id=u.idPrefix+l.key),l.span=document.createElement("span"),l.span.className="fancytree-node",h&&e(l.span).attr("aria-labelledby","ftal_"+l.key),l.li.appendChild(l.span),this.nodeRenderTitle(t),c._triggerNodeEvent("createnode",t)),c._triggerNodeEvent("rendernode",t)),g){if(v||l.expanded||r===!0){for(l.ul||(l.ul=document.createElement("ul"),(o===!0&&!a||!l.expanded)&&(l.ul.style.display="none"),h&&e(l.ul).attr("role","group"),l.li.appendChild(l.ul)),s=0,d=g.length;d>s;s++){var y=e.extend({},t,{node:g[s]});this.nodeRender(y,i,r,!1,!0)}var m=l.ul.firstChild;for(s=0,d=g.length-1;d>s;s++){var x=g[s],b=m.ftnode;x!==b?(l.debug("_fixOrder: mismatch at index "+s+": "+x+" != "+b),l.ul.insertBefore(x.li,b.li)):m=m.nextSibling}}}else l.ul&&(alert("remove child markup for "+l),this.nodeRemoveChildMarkup(t));v||(this.nodeRenderStatus(t),f&&p.ul.appendChild(l.li))},nodeRenderTitle:function(e,t){var n,i=e.node,r=e.tree,o=e.options,a=o.aria,s=i.getLevel(),d=[];if(void 0!==t&&(i.title=t),i.span){o.minExpandLevel>s?s>1&&(a?d.push("<span role='button' class='fancytree-expander'></span>"):d.push("<span class='fancytree-expander'></span>")):a?d.push("<span role='button' class='fancytree-expander'></span>"):d.push("<span class='fancytree-expander'></span>"),o.checkbox&&i.hideCheckbox!==!0&&!i.isStatusNode&&(a?d.push("<span role='checkbox' class='fancytree-checkbox'></span>"):d.push("<span class='fancytree-checkbox'></span>"));var l=i.data.icon;if(n=a?" role='img'":"",l){var c="/"===l.charAt(0)?l:o.imagePath+l;d.push("<img src='"+c+"' alt='' />")}else i.data.iconclass?d.push("<span "+n+" class='fancytree-custom-icon"+" "+i.data.iconclass+"'></span>"):l!==!1&&o.icons!==!1&&d.push("<span "+n+" class='fancytree-icon'></span>");var u="";if(o.onCustomRender&&(u=o.onCustomRender.call(r,i)||""),!u){var h=i.tooltip?" title='"+i.tooltip.replace(/\"/g,"&quot;")+"'":"",f=a?" id='ftal_"+i.key+"'":"";n=a?" role='treeitem'":"",u="<span "+n+" class='fancytree-title'"+f+h+">"+i.title+"</span>"}d.push(u),i.span.innerHTML=d.join("")}},nodeRenderStatus:function(t){var n=t.node,i=t.tree,r=t.options,o=n.hasChildren(),a=n.isLastSibling(),s=r.aria,d=e(n.span).find(".fancytree-title"),l=r._classNames,c=[],u=n[i.statusClassPropName];u&&(c.push(l.node),i.activeNode===n&&c.push(l.active),i.focusNode===n?(c.push(l.focused),s&&d.attr("aria-activedescendant",!0)):s&&d.removeAttr("aria-activedescendant"),n.expanded?(c.push(l.expanded),s&&d.attr("aria-expanded",!0)):s&&d.removeAttr("aria-expanded"),n.folder&&c.push(l.folder),o!==!1&&c.push(l.hasChildren),a&&c.push(l.lastsib),n.lazy&&null===n.children&&c.push(l.lazy),n.partsel&&c.push(l.partsel),n.selected?(c.push(l.selected),s&&d.attr("aria-selected",!0)):s&&d.attr("aria-selected",!1),n.extraClasses&&c.push(n.extraClasses),o===!1?c.push(l.combinedExpanderPrefix+"n"+(a?"l":"")):c.push(l.combinedExpanderPrefix+(n.expanded?"e":"c")+(n.lazy&&null===n.children?"d":"")+(a?"l":"")),c.push(l.combinedIconPrefix+(n.expanded?"e":"c")+(n.folder?"f":"")),n[i.statusClassPropName].className=c.join(" "),n.li&&(n.li.className=a?l.lastsib:""))},nodeSetActive:function(t,i){var r=t.node,s=t.tree,d=t.options,l=r===s.activeNode;if(i=i!==!1,r.debug("nodeSetActive",i),l===i)return o(r);if(i&&this._triggerNodeEvent("beforeActivate",r,t.orgEvent)===!1)return a(r,["rejected"]);if(i){if(s.activeNode){n(s.activeNode!==r,"node was active (inconsistency)");var c=e.extend({},t,{node:s.activeNode});s.nodeSetActive(c,!1),n(null===s.activeNode,"deactivate was out of sync?")}d.activeVisible&&s.nodeMakeVisible(t),s.activeNode=r,s.nodeRenderStatus(t),s.nodeSetFocus(t),s._triggerNodeEvent("activate",r)}else n(s.activeNode===r,"node was not active (inconsistency)"),s.activeNode=null,this.nodeRenderStatus(t),t.tree._triggerNodeEvent("deactivate",r)},nodeSetExpanded:function(t,n){var i=t.node,r=t.tree,s=t.options;if(n=n!==!1,i.debug("nodeSetExpanded("+n+")"),i.expanded&&n||!i.expanded&&!n)return i.debug("nodeSetExpanded("+n+"): nothing to do"),o(i);if(n&&!i.lazy&&!i.hasChildren())return a(i,["empty"]);if(!n&&i.getLevel()<s.minExpandLevel)return a(i,["locked"]);if(this._triggerNodeEvent("beforeExpand",i,t.orgEvent)===!1)return a(i,["rejected"]);var d=new e.Deferred;if(n&&!i.expanded&&s.autoCollapse){var l=i.getParentList(!1,!0),c=s.autoCollapse;try{s.autoCollapse=!1;for(var u=0,h=l.length;h>u;u++)this._callHook("nodeCollapseSiblings",l[u])}finally{s.autoCollapse=c}}d.done(function(){t.tree._triggerNodeEvent(n?"expand":"collapse",t),s.autoScroll&&i.getLastChild().scrollIntoView(!0,i)});var f=function(){if(i.expanded=n,r._callHook("nodeRender",t,!1,!1,!0),i.ul){var o="none"!==i.ul.style.display,a=!!i.expanded;if(o===a)i.warn("nodeSetExpanded: UL.style.display already set"),d.resolveWith(i);else if(s.fx){var l=s.fx.duration||200,c=s.fx.easing;i.debug("nodeSetExpanded: animate start..."),e(i.ul).animate(s.fx,l,c,function(){i.debug("nodeSetExpanded: animate done"),d.resolveWith(i)})}else i.ul.style.display=i.expanded||!parent?"":"none",d.resolveWith(i)}else d.resolveWith(i)};return n&&i.lazy&&void 0===i.hasChildren()?(i.debug("nodeSetExpanded: load start..."),i.lazyLoad().done(function(){i.debug("nodeSetExpanded: load done"),d.notifyWith&&d.notifyWith(i,["loaded"]),f.call(r)}).fail(function(e){d.rejectWith(i,["load failed ("+e+")"])})):f(),i.debug("nodeSetExpanded: returns"),d.promise()},nodeSetFocus:function(t,n){var i=t.tree,r=t.node;if(i.focusNode){if(i.focusNode===r&&n!==!1)return;var o=e.extend({},t,{node:i.focusNode});i.focusNode=null,this._triggerNodeEvent("blur",o),this._callHook("nodeRenderStatus",o)}n!==!1&&(m.focusTree!==i&&(r.debug("nodeSetFocus: forcing container focus"),i.setFocus()),this.nodeMakeVisible(t),i.focusNode=r,this._triggerNodeEvent("focus",t),t.options.autoScroll&&r.scrollIntoView(),this._callHook("nodeRenderStatus",t))},_fixSelectionState:function(e){function t(e,t){(t&&!e.partsel||!t&&e.partsel)&&(e.partsel=!!t,e.renderStatus())}var n,i,r;if(e.selected)for(e.visit(function(e){t(e.parent,!0),e.unselectable||e.selected||(e.selected=!0,e.renderStatus())}),n=e.parent;n;){var o=!0;for(i=0,r=n.children.length;r>i;i++){var a=n.children[i];if(!a.selected&&!a.isStatusNode&&!a.unselectable){o=!1;break}}n.partsel=!0,n.selected=o,n.renderStatus(),n=n.parent}else for(t(e,!1),e.visit(function(e){t(e,!1),e.selected&&(e.selected=!1,e.renderStatus())}),n=e.parent;n;){var s=!1;for(i=0,r=n.children.length;r>i;i++)if(n.children[i].selected||n.children[i].partsel){s=!0;break}n.selected=!1,n.partsel=s,n.renderStatus(),n=n.parent}},nodeSetSelected:function(e,t){var n=e.node,i=e.tree,r=e.options;return t=t!==!1,n.debug("nodeSetSelected("+t+")"),n.selected&&t||!n.selected&&!t?!!n.selected:this._triggerNodeEvent("beforeSelect",n,e.orgEvent)===!1?!!n.selected:(t&&1===r.selectMode?i.lastSelectedNode&&i.lastSelectedNode.setSelected(!1):3===r.selectMode&&(n.selected=t,this._fixSelectionState(n)),n.selected=t,this.nodeRenderStatus(e),i.lastSelectedNode=t?n:null,i._triggerNodeEvent("select",e),void 0)},nodeSetStatus:function(t,n,i,r){var o=t.node,a=t.tree,s=function(){var e=o.children?o.children[0]:null;if(e&&e.isStatusNode){try{o.ul&&(o.ul.removeChild(e.li),e.li=null)}catch(t){}1===o.children.length?o.children=[]:o.children.shift()}},d=function(t){var n=o.children?o.children[0]:null;return n&&n.isStatusNode?(e.extend(n,t),a._callHook("nodeRender",n)):(t.key="_statusNode",o._setChildren([t]),o.children[0].isStatusNode=!0,a.render()),o.children[0]};switch(n){case"ok":s(),e(o.span).removeClass("fancytree-loading");break;case"loading":e(o.span).addClass("fancytree-loading"),o.parent||d({title:a.options.strings.loading+(i?" ("+i+") ":""),tooltip:r,extraClasses:"fancytree-statusnode-wait"});break;case"error":e(o.span).addClass("fancytree-error"),d({title:a.options.strings.loadError+" ("+i+")",tooltip:r,extraClasses:"fancytree-statusnode-error"});break;default:e.error("invalid status "+n)}},nodeToggleExpanded:function(e){return this.nodeSetExpanded(e,!e.node.expanded)},nodeToggleSelected:function(e){return this.nodeSetSelected(e,!e.node.selected)},treeClear:function(e){var t=e.tree;t.activeNode=null,t.focusNode=null,t.$div.find(">ul.fancytree-container").empty(),t.rootNode.children=null},treeCreate:function(){},treeDestroy:function(){},treeInit:function(e){this.treeLoad(e)},treeLoad:function(n,i){var r,o=n.tree,a=n.widget.element,s=e.extend({},n,{node:this.rootNode});if(o.rootNode.children&&this.treeClear(n),i=i||this.options.source)"string"==typeof i&&t();else{var d,l=a.data("type")||"html";switch(l){case"html":d=a.find(">ul:first"),d.addClass("ui-fancytree-source ui-helper-hidden"),i=e.ui.fancytree.parseHtml(d);break;case"json":i=e.parseJSON(a.text()),i.children&&(i.title&&(o.title=i.title),i=i.children);break;default:e.error("Invalid data-type: "+l)}}return r=this.nodeLoadChildren(s,i).done(function(){o.render(),o._triggerTreeEvent("init",!0)}).fail(function(){o.render(),o._triggerTreeEvent("init",!1)})},treeOnFocusInOut:function(e){var t="focusin"===e.type;this.debug("treeOnFocusInOut("+t+")",e.type,e),m.focusTree&&(this===m.focusTree&&t||(m.focusTree.focusNode&&m.focusTree.focusNode.setFocus(!1),m.focusTree.$container.removeClass("fancytree-focused"),this._triggerTreeEvent("blurtree"))),t?(m.focusTree=this,this.$container.addClass("fancytree-focused"),this.focusNode||(this.activeNode?this.activeNode.setFocus():this.rootNode.hasChildren()&&this.rootNode.getFirstChild().setFocus()),this._triggerTreeEvent("focustree")):m.focusTree=null},treeSetFocus:function(e){e.tree.$container.focus()},reactivate:function(e){var t=this.activeNode;t&&(this.activeNode=null,t.setActive(),e&&t.setFocus())},reload:function(e){return this._callHook("treeClear",this),this._callHook("treeLoad",this,e)},render:function(e,t){return this.rootNode.render(e,t)},setFocus:function(e){return this._callHook("treeSetFocus",this,e)},toDict:function(e,t){return this.rootNode.toDict(e,t)},toString:function(){return"<Fancytree(#"+this._id+")>"},_triggerNodeEvent:function(e,t,n){var i=this._makeHookContext(t,n),r=this.widget._trigger(e,n,i);return r!==!1&&void 0!==i.result?i.result:r},_triggerTreeEvent:function(e,t){var n=this._makeHookContext(this,t),i=this.widget._trigger(e,t,n);return i!==!1&&void 0!==n.result?n.result:i},visit:function(e){return this.rootNode.visit(e,!1)},warn:function(){Array.prototype.unshift.call(arguments,""+this),m.warn.apply(this,arguments)}},e.widget("ui.fancytree",{options:{activeVisible:!0,ajax:{type:"GET",cache:!1,dataType:"json"},aria:!1,autoActivate:!0,autoCollapse:!1,autoScroll:!1,checkbox:!1,clickFolderMode:4,disabled:!1,extensions:[],fx:{height:"toggle",duration:200},generateIds:!1,icons:!0,idPrefix:"ft_",keyboard:!0,keyPathSeparator:"/",minExpandLevel:1,selectMode:2,strings:{loading:"Loading&#8230;",loadError:"Load error!"},tabbable:!0,_classNames:{container:"fancytree-container",node:"fancytree-node",folder:"fancytree-folder",empty:"fancytree-empty",vline:"fancytree-vline",expander:"fancytree-expander",checkbox:"fancytree-checkbox",icon:"fancytree-icon",title:"fancytree-title",noConnector:"fancytree-no-connector",statusnodeError:"fancytree-statusnode-error",statusnodeWait:"fancytree-statusnode-wait",hidden:"fancytree-hidden",combinedExpanderPrefix:"fancytree-exp-",combinedIconPrefix:"fancytree-ico-",loading:"fancytree-loading",hasChildren:"fancytree-has-children",active:"fancytree-active",selected:"fancytree-selected",expanded:"fancytree-expanded",lazy:"fancytree-lazy",focused:"fancytree-focused ui-state-focus",partsel:"fancytree-partsel",lastsib:"fancytree-lastsib"},lazyload:null},_create:function(){this.tree=new c(this),this.$source=this.source||"json"===this.element.data("type")?this.element:this.element.find(">ul:first");for(var t=this.options.extensions,i=this.tree,o=0;t.length>o;o++){var a=t[o],s=e.ui.fancytree._extensions[a];s||e.error("Could not apply extension '"+a+"' (it is not registered, did you forget to include it?)"),this.tree.options[a]=e.extend(!0,{},s.options,this.tree.options[a]),n(!this.tree[a],"Extension name must not exist as Fancytree attribute: "+a),this.tree[a]={},r(this.tree,i,s,a),i=s}this.tree._callHook("treeCreate",this.tree)},_init:function(){this.tree._callHook("treeInit",this.tree),this._bind()},_setOption:function(t,n){var i=!0,r=!1;switch(t){case"aria":case"checkbox":case"icons":case"minExpandLevel":case"tabbable":this.tree._callHook("treeCreate",this.tree),r=!0;break;case"source":i=!1,this.tree._callHook("treeLoad",this.tree,n)}this.tree.debug("set option "+t+"="+n+" <"+typeof n+">"),i&&e.Widget.prototype._setOption.apply(this,arguments),r&&this.tree.render(!0,!1)},destroy:function(){this._unbind(),this.tree._callHook("treeDestroy",this.tree),this.tree.$div.find(">ul.fancytree-container").remove(),this.$source&&this.$source.removeClass("ui-helper-hidden"),e.Widget.prototype.destroy.call(this)},_unbind:function(){var t=this.tree._ns;this.element.unbind(t),this.tree.$container.unbind(t),e(document).unbind(t)},_bind:function(){var t=this,n=this.options,i=this.tree,r=i._ns,o=e.support.selectstart?"selectstart":"mousedown";
this._unbind(),i.debug("bind events; container: ",i.$container),i.$container.bind("focusin"+r+" focusout"+r,function(e){i.debug("Tree container got event "+e.type),i.treeOnFocusInOut(e)}).delegate("span.fancytree-title",o+r,function(e){i.debug("<span> got event "+e.type),e.preventDefault()}),e(document).bind("keydown"+r,function(e){if(i.debug("doc got event "+e.type+", hasFocus:"+i.hasFocus()),n.disabled||n.keyboard===!1||!i.hasFocus())return!0;var t=i.focusNode,r=i._makeHookContext(t||i,e),o=i.phase;try{return i.phase="userEvent",t?i._triggerNodeEvent("keydown",t,e)===!1?!1:i._callHook("nodeKeydown",r):i._triggerTreeEvent("keydown",e)===!1?!1:i._callHook("nodeKeydown",r)}finally{i.phase=o}}),this.element.bind("click"+r+" dblclick"+r,function(e){if(n.disabled)return!0;var i=m.getEventTarget(e),r=i.node;if(!r)return!0;var o=t.tree,a=o._makeHookContext(r,e),s=o.phase;try{switch(o.phase="userEvent",e.type){case"click":return a.targetType=i.type,o._triggerNodeEvent("click",a,e)===!1?!1:o._callHook("nodeClick",a);case"dblclick":return a.targetType=i.type,o._triggerNodeEvent("dblclick",a,e)===!1?!1:o._callHook("nodeDblclick",a)}}finally{o.phase=s}})},getActiveNode:function(){return this.tree.activeNode},getNodeByKey:function(e){return this.tree.getNodeByKey(e)},getRootNode:function(){return this.tree.rootNode},getTree:function(){return this.tree}});var m=e.ui.fancytree;e.extend(e.ui.fancytree,{version:"2.0.0pre",debugLevel:2,_nextId:1,_nextNodeKey:1,_extensions:{},focusTree:null,_FancytreeClass:c,_FancytreeNodeClass:l,debug:function(){e.ui.fancytree.debugLevel>=2&&u("log",arguments)},error:function(){u("error",arguments)},getEventTargetType:function(e){return this.getEventTarget(e).type},getEventTarget:function(e){var t=e&&e.target?e.target.className:"",n={node:this.getNode(e.target),type:void 0};return"fancytree-title"===t?n.type="title":"fancytree-expander"===t?n.type=n.node.hasChildren()===!1?"prefix":"expander":"fancytree-checkbox"===t?n.type="checkbox":"fancytree-icon"===t?n.type="icon":t.indexOf("fancytree-node")>=0&&(n.type="title"),n},getNode:function(e){if(e instanceof l)return e;for(void 0!==e.selector?e=e[0]:void 0!==e.originalEvent&&(e=e.target);e;){if(e.ftnode)return e.ftnode;e=e.parentNode}return null},info:function(){e.ui.fancytree.debugLevel>=1&&u("info",arguments)},parseHtml:function(t){var n,i,r,o,a,s,d,l=t.find(">li"),c=[];return l.each(function(){var l=e(this),u=l.find(">span:first",this),h=u.length?null:l.find(">a:first"),v={tooltip:null,data:{}};for(u.length?v.title=u.html():h&&h.length?(v.title=h.html(),v.data.href=h.attr("href"),v.data.target=h.attr("target"),v.tooltip=h.attr("title")):(v.title=l.html(),o=v.title.search(/<ul/i),o>=0&&(v.title=v.title.substring(0,o))),v.title=e.trim(v.title),i=0,r=f.length;r>i;i++)v[f[i]]=void 0;for(s=this.className.split(" "),n=[],i=0,r=s.length;r>i;i++)d=s[i],p[d]?v[d]=!0:n.push(d);v.extraClasses=n.join(" "),a=l.attr("title"),a&&(v.tooltip=a),a=l.attr("id"),a&&(v.key=a);var g=l.data();if(g&&!e.isEmptyObject(g)){var y=g.json;delete g.json,e.extend(v.data,g),y&&e.extend(v.data,y)}t=l.find(">ul:first"),v.children=t.length?e.ui.fancytree.parseHtml(t):v.lazy?void 0:null,c.push(v)}),c},registerExtension:function(t,n){e.ui.fancytree._extensions[t]=n},warn:function(){u("warn",arguments)}})})(jQuery),function(e){e.ui.fancytree.registerExtension("profiler",{options:{prefix:""},nodeRender:function(e,t,n,i){var r=this.options.prefix+"render '"+e.node+"'";window.console&&window.console.time&&window.console.time(r),this._super(e,t,n,i),window.console&&window.console.timeEnd&&window.console.timeEnd(r)}})}(jQuery);